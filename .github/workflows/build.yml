name: Build and Package

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      do_release:
        description: 'Publish GitHub Release'
        required: false
        default: 'false'
      version_tag:
        description: 'Version tag, e.g., v1.0.4'
        required: false
        default: ''

jobs:
  check:
    name: Quick CI Check
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install frontend deps
      working-directory: quicksend/quicksend/quicksend/static
      run: npm install

    - name: Frontend build check
      working-directory: quicksend/quicksend/quicksend/static
      run: npm run build

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Backend syntax check
      run: python -m compileall -q quicksend/quicksend/quicksend

  build-windows:
    name: Build Windows ${{ matrix.arch }}
    runs-on: windows-latest
    needs: check
    if: >
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) ||
      (github.event_name == 'workflow_dispatch')
    strategy:
      matrix:
        arch: [x64, x86]
        include:
          - arch: x64
            python-arch: 'x64'
            nsi-script: 'QuickSend.nsi'
            artifact-suffix: 'win64'
          - arch: x86
            python-arch: 'x86'
            nsi-script: 'installer_x86.nsi'
            artifact-suffix: 'win32'

    steps:
    - uses: actions/checkout@v4

    - name: Prepare Analytics Config (Embed into installer)
      working-directory: quicksend/quicksend/quicksend
      shell: pwsh
      env:
        SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      run: |
        $anon = $env:SUPABASE_ANON_KEY
        if ([string]::IsNullOrEmpty($anon)) { throw "Missing required GitHub Secret: SUPABASE_ANON_KEY" }

        $url = $env:SUPABASE_URL
        if ([string]::IsNullOrEmpty($url)) {
          if ([string]::IsNullOrEmpty($env:SUPABASE_PROJECT_REF)) { throw "Missing SUPABASE_URL and SUPABASE_PROJECT_REF (need one to build URL)" }
          $url = "https://$($env:SUPABASE_PROJECT_REF).supabase.co"
        }

        @{ supabase_url = $url; supabase_anon_key = $anon } |
          ConvertTo-Json -Compress |
          Out-File -Encoding utf8 analytics_config.json

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Build Frontend
      working-directory: quicksend/quicksend/quicksend/static
      run: |
        npm install
        npm run build

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        architecture: ${{ matrix.python-arch }}

    - name: Install Dependencies
      working-directory: quicksend/quicksend/quicksend
      run: |
        pip install flask "pyinstaller>=6.0" werkzeug pywebview pillow jaraco.text pythonnet clr_loader
        pip install platformdirs

    - name: Generate Icon
      working-directory: quicksend/quicksend/quicksend
      run: |
        python -c "from PIL import Image; import os; img_path='logo2.png' if os.path.exists('logo2.png') else 'logo.png'; img=Image.open(img_path) if os.path.exists(img_path) else None; img.save('logo.ico', sizes=[(256,256),(128,128),(64,64),(32,32),(16,16)]) if img else print('Logo not found, skipping icon generation')"

    - name: Prepare Static Assets
      working-directory: quicksend/quicksend/quicksend
      shell: bash
      run: |
        cp static/dist/index.html static/index.build.html

    - name: Run PyInstaller
      working-directory: quicksend/quicksend/quicksend
      run: |
        pyinstaller --noconfirm --clean --noconsole --onedir --name "QuickSend" --add-data "analytics_config.json;." --add-data "static/dist;static/dist" --add-data "static/fonts;static/fonts" --add-data "static/index.build.html;static" --add-data "static/script.js;static" --hidden-import=flask --hidden-import=werkzeug --hidden-import=jinja2 --hidden-import=click --hidden-import=itsdangerous --hidden-import=markupsafe --hidden-import=webview --hidden-import=clr_loader --hidden-import=pythonnet --hidden-import=jaraco.text --collect-all flask --collect-all werkzeug --collect-all clr_loader --collect-all pythonnet --collect-datas jaraco.text --collect-all platformdirs --icon=logo.ico app.py

    - name: Post-Build Copy (Fix missing files)
      working-directory: quicksend/quicksend/quicksend
      shell: bash
      run: |
        # Copy missing assets (logic from bat file)
        if [ -d "dist/QuickSend/_internal" ]; then
            mkdir -p "dist/QuickSend/_internal/static/dist"
            cp -r static/dist/* "dist/QuickSend/_internal/static/dist/"
        else
            mkdir -p "dist/QuickSend/static/dist"
            cp -r static/dist/* "dist/QuickSend/static/dist/"
        fi
        if [ -f "logo.ico" ]; then
            cp logo.ico dist/QuickSend/
        fi
        rm -f analytics_config.json || true

    - name: Setup NSIS
      run: |
        choco install nsis
        # Add NSIS to PATH for subsequent steps
        echo "C:\Program Files (x86)\NSIS" >> $env:GITHUB_PATH

    - name: Run NSIS
      working-directory: quicksend/quicksend/quicksend
      run: |
        $evt = "${{ github.event_name }}"; $name = ""; if ($evt -eq "workflow_dispatch" -and -not [string]::IsNullOrEmpty("${{ github.event.inputs.version_tag }}")) { $name = "${{ github.event.inputs.version_tag }}"; } elseif ("${{ github.ref }}".StartsWith("refs/tags/")) { $name = "${{ github.ref_name }}"; } else { $name = "1.0.1" }; if ($name.StartsWith("v")) { $ver = $name.Substring(1) } else { $ver = $name }; echo "VERSION_NO_V=$ver" >> $env:GITHUB_ENV
        makensis /INPUTCHARSET UTF8 /DPRODUCT_VERSION=$env:VERSION_NO_V ..\..\installer\${{ matrix.nsi-script }}

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: QuickSend-Windows-${{ matrix.arch }}
        path: quicksend/installer/*.exe

  build-macos:
    name: Build macOS ${{ matrix.arch-name }}
    runs-on: ${{ matrix.os }}
    needs: check
    if: >
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) ||
      (github.event_name == 'workflow_dispatch')
    strategy:
      matrix:
        include:
          - os: macos-14
            arch-name: 'Intel'
            artifact-suffix: 'x86_64'
            python-arch: 'x64'
          - os: macos-14
            arch-name: 'Apple Silicon'
            artifact-suffix: 'arm64'
            python-arch: 'arm64'
    steps:
    - uses: actions/checkout@v4

    - name: Prepare Analytics Config (Embed into app)
      working-directory: quicksend/quicksend/quicksend
      shell: bash
      env:
        SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      run: |
        set -euo pipefail
        if [ -z "${SUPABASE_ANON_KEY:-}" ]; then
          echo "Missing required GitHub Secret: SUPABASE_ANON_KEY"
          exit 1
        fi
        if [ -z "${SUPABASE_URL:-}" ]; then
          if [ -z "${SUPABASE_PROJECT_REF:-}" ]; then
            echo "Missing SUPABASE_URL and SUPABASE_PROJECT_REF (need one to build URL)"
            exit 1
          fi
          SUPABASE_URL="https://${SUPABASE_PROJECT_REF}.supabase.co"
        fi
        printf '{"supabase_url":"%s","supabase_anon_key":"%s"}' "$SUPABASE_URL" "$SUPABASE_ANON_KEY" > analytics_config.json

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Build Frontend
      working-directory: quicksend/quicksend/quicksend/static
      run: |
        npm install
        npm run build

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        architecture: ${{ matrix.python-arch }}

    - name: Install Dependencies
      working-directory: quicksend/quicksend/quicksend
      run: |
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Prepare Static Assets
      working-directory: quicksend/quicksend/quicksend
      shell: bash
      run: |
        cp static/dist/index.html static/index.build.html

    - name: Build App
      working-directory: quicksend/quicksend/quicksend
      run: |
        # Create a new build script on the fly to avoid modification errors
        cat > build_mac_ci.sh <<'EOS'
        #!/usr/bin/env bash
        set -e
        NAME=QuickSend

        # 1. Logo Handling
        if [ -f "../maclogo.png" ]; then
          echo "Found maclogo.png in parent directory, copying to logo2_.png"
          cp "../maclogo.png" logo2_.png
        elif [ -f "maclogo.png" ]; then
           echo "Found maclogo.png in current directory"
           cp maclogo.png logo2_.png
        fi

        # 2. Dependencies
        if [ -f requirements.txt ]; then
          python3 -m pip install -q -r requirements.txt
        fi
        python3 -m pip install -q PyInstaller

        # 3. Icon Generation
        if [ ! -f "logo2_.icns" ] && [ -d "assets/icon.iconset" ]; then
          echo "Generating logo2_.icns from assets/icon.iconset..."
          iconutil -c icns assets/icon.iconset -o logo2_.icns || true
        fi

        if [ -f "logo2_.png" ] && [ ! -f "logo2_.icns" ]; then
          mkdir -p assets/icon.iconset
          sips -z 16 16 logo2_.png --out assets/icon.iconset/icon_16x16.png >/dev/null
          sips -z 32 32 logo2_.png --out assets/icon.iconset/icon_16x16@2x.png >/dev/null
          sips -z 32 32 logo2_.png --out assets/icon.iconset/icon_32x32.png >/dev/null
          sips -z 64 64 logo2_.png --out assets/icon.iconset/icon_32x32@2x.png >/dev/null
          sips -z 128 128 logo2_.png --out assets/icon.iconset/icon_128x128.png >/dev/null
          sips -z 256 256 logo2_.png --out assets/icon.iconset/icon_128x128@2x.png >/dev/null
          sips -z 256 256 logo2_.png --out assets/icon.iconset/icon_256x256.png >/dev/null
          sips -z 512 512 logo2_.png --out assets/icon.iconset/icon_256x256@2x.png >/dev/null
          sips -z 512 512 logo2_.png --out assets/icon.iconset/icon_512x512.png >/dev/null
          sips -z 1024 1024 logo2_.png --out assets/icon.iconset/icon_512x512@2x.png >/dev/null
          iconutil -c icns assets/icon.iconset -o logo2_.icns >/dev/null || true
        fi
        
        ICON_OPT=""
        if [ -f maclogo.icns ]; then
          ICON_OPT="--icon=maclogo.icns"
        elif [ -f logo2_.icns ]; then
          ICON_OPT="--icon=logo2_.icns"
        elif [ -f assets/logo.icns ]; then
          ICON_OPT="--icon=assets/logo.icns"
        fi

        # 4. PyInstaller Build
        echo "Running PyInstaller..."
        ANALYTICS_DATA_OPT=""
        if [ -f analytics_config.json ]; then
          ANALYTICS_DATA_OPT='--add-data "analytics_config.json:."'
        fi
        python3 -m PyInstaller --clean --windowed --onedir --name "$NAME" --osx-bundle-identifier com.quicksend.app \
          $ANALYTICS_DATA_OPT \
          --add-data "static/dist:static/dist" \
          --add-data "static/fonts:static/fonts" \
          --add-data "static/index.build.html:static" \
          --add-data "static/index.html:static" \
          --add-data "static/script.js:static" \
          --add-data "static/favicon.ico:static" \
          --add-data "static/favicon.png:static" \
          --hidden-import werkzeug.security \
          $ICON_OPT app.py

        # 5. DMG Creation
        echo "Creating DMG..."
        rm -f "dist/${NAME}-mac.dmg"
        mkdir -p dist

        DMG_TMP="$(mktemp -d)"
        trap 'rm -rf "$DMG_TMP"' EXIT
        ditto "dist/${NAME}.app" "$DMG_TMP/${NAME}.app"
        ln -s /Applications "$DMG_TMP/Applications" || true

        for attempt in 1 2 3 4 5; do
          if hdiutil create -volname "${NAME}" -srcfolder "$DMG_TMP" -ov -format UDZO "dist/${NAME}-mac.dmg"; then
            break
          fi
          sleep $((attempt * 3))
        done

        if [ ! -f "dist/${NAME}-mac.dmg" ]; then
          exit 1
        fi
        
        echo "DMG Created: dist/${NAME}-mac.dmg"
        EOS

        chmod +x build_mac_ci.sh
        ./build_mac_ci.sh
        rm -f analytics_config.json || true
        
        # Rename dmg to include architecture
        if [ -f "dist/QuickSend-mac.dmg" ]; then
          mv "dist/QuickSend-mac.dmg" "dist/QuickSend-mac-${{ matrix.artifact-suffix }}.dmg"
        fi

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: QuickSend-macOS-${{ matrix.artifact-suffix }}
        path: quicksend/quicksend/quicksend/dist/QuickSend-mac-${{ matrix.artifact-suffix }}.dmg

  build-docker:
    name: Build Docker
    runs-on: ubuntu-latest
    needs: check
    if: >
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')) ||
      (github.event_name == 'workflow_dispatch')
    env:
      DOCKER_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
    steps:
    - uses: actions/checkout@v4

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Set Version Tag
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ github.event.inputs.version_tag }}" ]]; then
          echo "VERSION_TAG=${{ github.event.inputs.version_tag }}" >> $GITHUB_ENV
        elif [[ "${GITHUB_REF}" == refs/tags/* ]]; then
          echo "VERSION_TAG=${GITHUB_REF_NAME}" >> $GITHUB_ENV
        else
          echo "VERSION_TAG=latest" >> $GITHUB_ENV
        fi

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      if: github.event_name != 'pull_request' && env.DOCKER_USERNAME != ''
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build and push (with Secrets)
      if: env.DOCKER_USERNAME != ''
      uses: docker/build-push-action@v5
      with:
        context: quicksend/quicksend/quicksend
        file: quicksend/quicksend/quicksend/Dockerfile
        platforms: linux/amd64,linux/arm64,linux/386
        push: ${{ github.event_name != 'pull_request' }}
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/quicksend:latest
          ${{ secrets.DOCKERHUB_USERNAME }}/quicksend:${{ env.VERSION_TAG }}

    - name: Build only (No Secrets)
      if: env.DOCKER_USERNAME == ''
      uses: docker/build-push-action@v5
      with:
        context: quicksend/quicksend/quicksend
        file: quicksend/quicksend/quicksend/Dockerfile
        platforms: linux/amd64
        push: false
        tags: quicksend:local
        outputs: type=tar,dest=/tmp/quicksend-image-${{ env.VERSION_TAG }}.tar

    - name: Upload Docker Artifact
      if: env.DOCKER_USERNAME == ''
      uses: actions/upload-artifact@v4
      with:
        name: docker-image-${{ env.VERSION_TAG }}
        path: /tmp/quicksend-image-${{ env.VERSION_TAG }}.tar

    - name: Export Docker manifest
      if: env.DOCKER_USERNAME != ''
      run: |
        docker buildx imagetools inspect ${{ secrets.DOCKERHUB_USERNAME }}/quicksend:${{ env.VERSION_TAG }} -raw > /tmp/docker-manifest.json

    - name: Upload Docker Manifest Artifact
      if: env.DOCKER_USERNAME != ''
      uses: actions/upload-artifact@v4
      with:
        name: docker-manifest
        path: /tmp/docker-manifest.json

  release:
    name: Publish Release
    if: startsWith(github.ref, 'refs/tags/') || (github.event_name == 'workflow_dispatch' && github.event.inputs.do_release == 'true')
    needs:
      - build-windows
      - build-macos
      - build-docker
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4

    - name: Download Windows x64
      uses: actions/download-artifact@v4
      with:
        name: QuickSend-Windows-x64
        path: artifacts/windows/x64

    - name: Download Windows x86
      uses: actions/download-artifact@v4
      with:
        name: QuickSend-Windows-x86
        path: artifacts/windows/x86

    - name: Download macOS x86_64
      uses: actions/download-artifact@v4
      with:
        name: QuickSend-macOS-x86_64
        path: artifacts/macos/x86_64

    - name: Download macOS arm64
      uses: actions/download-artifact@v4
      with:
        name: QuickSend-macOS-arm64
        path: artifacts/macos/arm64

    - name: Download Docker Manifest
      uses: actions/download-artifact@v4
      with:
        name: docker-manifest
        path: artifacts/docker
      continue-on-error: true

    - name: Download Docker Image Tar
      uses: actions/download-artifact@v4
      with:
        name: docker-image-${{ github.ref_name }}
        path: artifacts/docker
      continue-on-error: true

    - name: Download Docker Image Tar (manual version_tag)
      uses: actions/download-artifact@v4
      with:
        name: docker-image-${{ github.event.inputs.version_tag }}
        path: artifacts/docker
      continue-on-error: true

    - name: Gather Release Assets
      run: |
        mkdir -p release
        cp artifacts/windows/x64/*.exe release/ || true
        cp artifacts/windows/x86/*.exe release/ || true
        cp artifacts/macos/x86_64/*.dmg release/ || true
        cp artifacts/macos/arm64/*.dmg release/ || true
        cp artifacts/docker/docker-manifest.json release/ || true
        cp artifacts/docker/*.tar release/ || true

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.version_tag || github.ref_name }}
        name: QuickSend ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.version_tag || github.ref_name }}
        draft: false
        prerelease: false
        files: |
          release/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
