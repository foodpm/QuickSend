name: Build and Package

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    name: Build Windows ${{ matrix.arch }}
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, x86]
        include:
          - arch: x64
            python-arch: 'x64'
            nsi-script: 'QuickSend.nsi'
            artifact-suffix: 'win64'
          - arch: x86
            python-arch: 'x86'
            nsi-script: 'installer_x86.nsi'
            artifact-suffix: 'win32'

    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Build Frontend
      working-directory: quicksend/quicksend/quicksend/static
      run: |
        npm install
        npm run build

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        architecture: ${{ matrix.python-arch }}

    - name: Install Dependencies
      working-directory: quicksend/quicksend/quicksend
      run: |
        pip install flask "pyinstaller>=6.0" werkzeug pywebview pillow jaraco.text pythonnet clr_loader
        pip install platformdirs

    - name: Generate Icon
      working-directory: quicksend/quicksend/quicksend
      run: |
        python -c "from PIL import Image; import os; img_path='logo2.png' if os.path.exists('logo2.png') else 'logo.png'; img=Image.open(img_path) if os.path.exists(img_path) else None; img.save('logo.ico', sizes=[(256,256),(128,128),(64,64),(32,32),(16,16)]) if img else print('Logo not found, skipping icon generation')"

    - name: Prepare Static Assets
      working-directory: quicksend/quicksend/quicksend
      shell: bash
      run: |
        cp static/dist/index.html static/index.build.html

    - name: Run PyInstaller
      working-directory: quicksend/quicksend/quicksend
      run: |
        pyinstaller --noconfirm --clean --noconsole --onedir --name "QuickSend" --add-data "static/dist;static/dist" --add-data "static/fonts;static/fonts" --add-data "static/index.build.html;static" --add-data "static/script.js;static" --hidden-import=flask --hidden-import=werkzeug --hidden-import=jinja2 --hidden-import=click --hidden-import=itsdangerous --hidden-import=markupsafe --hidden-import=webview --hidden-import=clr_loader --hidden-import=pythonnet --hidden-import=jaraco.text --collect-all flask --collect-all werkzeug --collect-all clr_loader --collect-all pythonnet --collect-datas jaraco.text --collect-all platformdirs --icon=logo.ico app.py

    - name: Post-Build Copy (Fix missing files)
      working-directory: quicksend/quicksend/quicksend
      shell: bash
      run: |
        # Copy missing assets (logic from bat file)
        if [ -d "dist/QuickSend/_internal" ]; then
            mkdir -p "dist/QuickSend/_internal/static/dist"
            cp -r static/dist/* "dist/QuickSend/_internal/static/dist/"
        else
            mkdir -p "dist/QuickSend/static/dist"
            cp -r static/dist/* "dist/QuickSend/static/dist/"
        fi
        if [ -f "logo.ico" ]; then
            cp logo.ico dist/QuickSend/
        fi

    - name: Setup NSIS
      run: choco install nsis

    - name: Run NSIS
      working-directory: quicksend/quicksend/quicksend
      run: |
        makensis /INPUTCHARSET UTF8 ..\..\installer\${{ matrix.nsi-script }}

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: QuickSend-Windows-${{ matrix.arch }}
        path: quicksend/installer/*.exe

  build-macos:
    name: Build macOS ${{ matrix.arch-name }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: macos-14
            arch-name: 'Intel'
            artifact-suffix: 'x86_64'
            python-arch: 'x64'
          - os: macos-14
            arch-name: 'Apple Silicon'
            artifact-suffix: 'arm64'
            python-arch: 'arm64'
    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Build Frontend
      working-directory: quicksend/quicksend/quicksend/static
      run: |
        npm install
        npm run build

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        architecture: ${{ matrix.python-arch }}

    - name: Install Dependencies
      working-directory: quicksend/quicksend/quicksend
      run: |
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Prepare Static Assets
      working-directory: quicksend/quicksend/quicksend
      shell: bash
      run: |
        cp static/dist/index.html static/index.build.html

    - name: Build App
      working-directory: quicksend/quicksend/quicksend
      run: |
        # Create a new build script on the fly to avoid modification errors
        cat > build_mac_ci.sh <<'EOS'
        #!/usr/bin/env bash
        set -e
        NAME=QuickSend

        # 1. Logo Handling
        if [ -f "../maclogo.png" ]; then
          echo "Found maclogo.png in parent directory, copying to logo2_.png"
          cp "../maclogo.png" logo2_.png
        elif [ -f "maclogo.png" ]; then
           echo "Found maclogo.png in current directory"
           cp maclogo.png logo2_.png
        fi

        # 2. Dependencies
        if [ -f requirements.txt ]; then
          python3 -m pip install -q -r requirements.txt
        fi
        python3 -m pip install -q PyInstaller

        # 3. Icon Generation
        if [ ! -f "logo2_.icns" ] && [ -d "assets/icon.iconset" ]; then
          echo "Generating logo2_.icns from assets/icon.iconset..."
          iconutil -c icns assets/icon.iconset -o logo2_.icns || true
        fi

        if [ -f "logo2_.png" ] && [ ! -f "logo2_.icns" ]; then
          mkdir -p assets/icon.iconset
          sips -z 16 16 logo2_.png --out assets/icon.iconset/icon_16x16.png >/dev/null
          sips -z 32 32 logo2_.png --out assets/icon.iconset/icon_16x16@2x.png >/dev/null
          sips -z 32 32 logo2_.png --out assets/icon.iconset/icon_32x32.png >/dev/null
          sips -z 64 64 logo2_.png --out assets/icon.iconset/icon_32x32@2x.png >/dev/null
          sips -z 128 128 logo2_.png --out assets/icon.iconset/icon_128x128.png >/dev/null
          sips -z 256 256 logo2_.png --out assets/icon.iconset/icon_128x128@2x.png >/dev/null
          sips -z 256 256 logo2_.png --out assets/icon.iconset/icon_256x256.png >/dev/null
          sips -z 512 512 logo2_.png --out assets/icon.iconset/icon_256x256@2x.png >/dev/null
          sips -z 512 512 logo2_.png --out assets/icon.iconset/icon_512x512.png >/dev/null
          sips -z 1024 1024 logo2_.png --out assets/icon.iconset/icon_512x512@2x.png >/dev/null
          iconutil -c icns assets/icon.iconset -o logo2_.icns >/dev/null || true
        fi
        
        ICON_OPT=""
        if [ -f maclogo.icns ]; then
          ICON_OPT="--icon=maclogo.icns"
        elif [ -f logo2_.icns ]; then
          ICON_OPT="--icon=logo2_.icns"
        elif [ -f assets/logo.icns ]; then
          ICON_OPT="--icon=assets/logo.icns"
        fi

        # 4. PyInstaller Build
        echo "Running PyInstaller..."
        python3 -m PyInstaller --clean --windowed --onedir --name "$NAME" --osx-bundle-identifier com.quicksend.app \
          --add-data "static/dist:static/dist" \
          --add-data "static/fonts:static/fonts" \
          --add-data "static/index.build.html:static" \
          --add-data "static/index.html:static" \
          --add-data "static/script.js:static" \
          --add-data "static/favicon.ico:static" \
          --add-data "static/favicon.png:static" \
          --hidden-import werkzeug.security \
          $ICON_OPT app.py

        # 5. DMG Creation
        echo "Creating DMG..."
        rm -f "dist/${NAME}-mac.dmg"
        mkdir -p dist
        
        DMG_TMP="dist/${NAME}-dmg"
        rm -rf "$DMG_TMP"
        mkdir -p "$DMG_TMP"
        cp -R "dist/${NAME}.app" "$DMG_TMP/"
        ln -s /Applications "$DMG_TMP/Applications" || true
        hdiutil create -volname "${NAME}" -srcfolder "$DMG_TMP" -ov -format UDZO "dist/${NAME}-mac.dmg"
        rm -rf "$DMG_TMP"
        
        echo "DMG Created: dist/${NAME}-mac.dmg"
        EOS

        chmod +x build_mac_ci.sh
        ./build_mac_ci.sh
        
        # Rename dmg to include architecture
        if [ -f "dist/QuickSend-mac.dmg" ]; then
          mv "dist/QuickSend-mac.dmg" "dist/QuickSend-mac-${{ matrix.artifact-suffix }}.dmg"
        fi

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: QuickSend-macOS-${{ matrix.artifact-suffix }}
        path: quicksend/quicksend/quicksend/dist/QuickSend-mac-${{ matrix.artifact-suffix }}.dmg

  build-docker:
    name: Build Docker
    runs-on: ubuntu-latest
    env:
      DOCKER_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
    steps:
    - uses: actions/checkout@v4

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      if: github.event_name != 'pull_request' && env.DOCKER_USERNAME != ''
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Build and push (with Secrets)
      if: env.DOCKER_USERNAME != ''
      uses: docker/build-push-action@v5
      with:
        context: quicksend/quicksend/quicksend
        file: quicksend/quicksend/quicksend/Dockerfile
        platforms: linux/amd64,linux/arm64,linux/386
        push: ${{ github.event_name != 'pull_request' }}
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/quicksend:latest
          ${{ secrets.DOCKERHUB_USERNAME }}/quicksend:${{ github.sha }}

    - name: Build only (No Secrets)
      if: env.DOCKER_USERNAME == ''
      uses: docker/build-push-action@v5
      with:
        context: quicksend/quicksend/quicksend
        file: quicksend/quicksend/quicksend/Dockerfile
        platforms: linux/amd64,linux/arm64,linux/386
        push: false
        tags: quicksend:local
        outputs: type=tar,dest=/tmp/docker-image.tar

    - name: Upload Docker Artifact
      if: env.DOCKER_USERNAME == ''
      uses: actions/upload-artifact@v4
      with:
        name: docker-image
        path: /tmp/docker-image.tar
